# 监控与告警配置指南

## 一、概述

本文档说明如何配置云函数的监控和告警，以便及时发现问题。

## 二、访问监控控制台

### 1. 云函数监控

**地址**：https://console.cloud.tencent.com/tcb/scf?envId=yang0313-7g4dqwd46c63d876

### 2. 云监控控制台

**地址**：https://console.cloud.tencent.com/monitor

## 三、查看监控指标

### 1. 函数调用统计

在云函数控制台可以查看：
- **调用次数**：函数被调用的总次数
- **错误次数**：函数执行失败的次数
- **错误率**：错误次数 / 调用次数
- **平均执行时间**：函数平均执行时长
- **并发数**：同时执行的函数实例数

### 2. 资源使用情况

- **内存使用**：函数内存使用情况
- **执行时长分布**：不同时长的执行次数分布
- **流量统计**：函数产生的网络流量

## 四、配置告警策略

### 1. 创建告警策略

1. 进入云监控控制台
2. 点击「**告警管理**」→「**告警策略**」
3. 点击「**新建**」

### 2. 配置告警规则

#### 规则 1：函数错误率告警

```
策略名称: 云函数错误率过高
策略类型: 云函数
监控指标: 错误率
统计周期: 5分钟
计算方式: 平均值
告警条件: > 5%
持续周期: 2个周期
```

#### 规则 2：函数执行时间告警

```
策略名称: 云函数执行时间过长
策略类型: 云函数
监控指标: 执行时间
统计周期: 5分钟
计算方式: 平均值
告警条件: > 5000ms
持续周期: 2个周期
```

#### 规则 3：函数并发数告警

```
策略名称: 云函数并发数过高
策略类型: 云函数
监控指标: 并发数
统计周期: 5分钟
计算方式: 最大值
告警条件: > 100
持续周期: 2个周期
```

#### 规则 4：函数调用次数异常

```
策略名称: 云函数调用次数异常
策略类型: 云函数
监控指标: 调用次数
统计周期: 5分钟
计算方式: 总和
告警条件: < 10 或 > 10000
持续周期: 2个周期
```

### 3. 配置通知方式

1. **邮件通知**
   - 添加接收邮箱
   - 设置通知频率（每次告警 / 每天一次）

2. **短信通知**
   - 添加接收手机号
   - 设置通知频率

3. **微信通知**
   - 绑定微信公众号
   - 接收告警消息

4. **企业微信 / 钉钉**
   - 配置 Webhook
   - 接收告警消息

## 五、配置日志告警

### 1. 查看函数日志

1. 进入云函数控制台
2. 选择函数
3. 点击「**日志查询**」
4. 查看执行日志

### 2. 配置日志告警

1. 进入「**日志服务**」
2. 创建日志告警规则
3. 配置关键词匹配：
   - 错误关键词：`Error`, `Exception`, `Failed`
   - 告警条件：匹配到关键词时告警

## 六、配置性能监控

### 1. 慢查询监控

对于数据库操作，监控慢查询：

1. 在云函数日志中查找执行时间 > 3秒的请求
2. 分析慢查询原因
3. 优化数据库查询

### 2. 内存泄漏监控

1. 监控函数内存使用趋势
2. 如果内存持续增长，可能存在内存泄漏
3. 检查代码中的资源释放

## 七、配置自定义监控

### 1. 在代码中添加监控点

```javascript
// 记录关键操作
console.log('[MONITOR]', {
  action: 'user_login',
  userId: user.id,
  duration: Date.now() - startTime,
  success: true
});
```

### 2. 使用日志分析

1. 在日志中搜索特定关键词
2. 统计操作次数
3. 分析性能瓶颈

## 八、最佳实践

### 1. 告警级别

- **严重**：服务不可用、大量错误
- **警告**：性能下降、错误率上升
- **信息**：异常调用、资源使用异常

### 2. 告警频率

- 避免告警风暴：设置合理的告警频率
- 重要告警：立即通知
- 一般告警：汇总后通知

### 3. 告警处理

1. **及时响应**：收到告警后及时处理
2. **记录问题**：记录告警原因和处理方法
3. **优化改进**：根据告警优化代码和配置

## 九、常见告警场景

### 1. 函数错误率突然上升

**可能原因**：
- 代码更新引入 bug
- 依赖服务不可用
- 数据库连接失败

**处理方法**：
1. 查看错误日志
2. 回滚代码（如需要）
3. 检查依赖服务状态

### 2. 函数执行时间变长

**可能原因**：
- 数据库查询变慢
- 外部 API 响应慢
- 代码逻辑问题

**处理方法**：
1. 分析慢查询
2. 优化数据库索引
3. 添加缓存

### 3. 并发数过高

**可能原因**：
- 流量突增
- 函数执行时间过长
- 恶意请求

**处理方法**：
1. 检查流量来源
2. 增加函数并发上限
3. 添加限流

## 十、监控仪表板

### 1. 创建监控仪表板

1. 进入云监控控制台
2. 创建自定义仪表板
3. 添加监控图表：
   - 函数调用次数趋势
   - 错误率趋势
   - 平均执行时间
   - 并发数

### 2. 分享仪表板

1. 生成仪表板链接
2. 分享给团队成员
3. 定期查看监控数据

## 十一、下一步

完成监控配置后：

1. ✅ **定期查看监控数据** - 了解系统运行状况
2. ✅ **及时处理告警** - 确保服务稳定
3. ✅ **优化性能** - 根据监控数据优化代码

---

**更新时间**: 2025年1月
**状态**: ✅ 监控配置指南已就绪

