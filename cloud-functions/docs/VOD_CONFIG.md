# VOD 云点播配置指南

## 一、概述

本项目使用腾讯云点播（VOD）服务处理视频文件，包括：
- 视频转码（多清晰度）
- 视频封面生成
- 视频播放
- 视频审核

## 二、开通服务

### 1. 访问 VOD 控制台

**地址**：https://console.cloud.tencent.com/vod

### 2. 开通服务

1. 首次使用需要开通云点播服务
2. 选择计费方式：
   - **按量计费**：适合初期使用
   - **资源包**：适合大量使用

### 3. 创建子应用（可选）

1. 进入「**应用管理**」
2. 点击「**创建应用**」
3. 填写应用信息：
   - 应用名称：`heiha-vod`
   - 应用描述：嘿哈视频平台
4. 记录子应用 ID（SubAppId）

> **注意**：如果不创建子应用，使用默认子应用（SubAppId: 0）

## 三、配置转码模板

### 1. 进入转码模板

1. 进入「**视频处理**」→「**转码模板**」
2. 点击「**创建转码模板**」

### 2. 创建标准转码模板

#### 模板 1：流畅（360p）

```
模板名称: 流畅
封装格式: MP4
视频编码: H.264
分辨率: 640x360
码率: 500 kbps
帧率: 25 fps
音频编码: AAC
音频码率: 64 kbps
```

#### 模板 2：标清（480p）

```
模板名称: 标清
封装格式: MP4
视频编码: H.264
分辨率: 854x480
码率: 1000 kbps
帧率: 25 fps
音频编码: AAC
音频码率: 128 kbps
```

#### 模板 3：高清（720p）

```
模板名称: 高清
封装格式: MP4
视频编码: H.264
分辨率: 1280x720
码率: 2500 kbps
帧率: 25 fps
音频编码: AAC
音频码率: 128 kbps
```

#### 模板 4：超清（1080p）

```
模板名称: 超清
封装格式: MP4
视频编码: H.264
分辨率: 1920x1080
码率: 5000 kbps
帧率: 25 fps
音频编码: AAC
音频码率: 192 kbps
```

### 3. 创建自适应码流模板（HLS）

1. 进入「**视频处理**」→「**自适应码流模板**」
2. 创建 HLS 模板：
   - 模板名称：`HLS-多码率`
   - 包含上述所有清晰度模板

## 四、配置封面生成

### 1. 进入截图模板

1. 进入「**视频处理**」→「**截图模板**」
2. 点击「**创建截图模板**」

### 2. 创建封面模板

#### 模板 1：时间点截图

```
模板名称: 封面截图
截图类型: 时间点截图
时间点: 1秒（视频第一秒）
图片格式: JPG
图片宽度: 1280
图片高度: 720
```

#### 模板 2：采样截图（可选）

```
模板名称: 采样截图
截图类型: 采样截图
采样间隔: 10秒
采样数量: 10张
图片格式: JPG
图片宽度: 640
图片高度: 360
```

## 五、配置事件通知

### 1. 进入事件通知配置

1. 进入「**回调配置**」→「**事件通知**」
2. 点击「**添加回调配置**」

### 2. 配置回调地址

```
回调模式: 可靠回调
回调 URL: https://yang0313-7g4dqwd46c63d876.ap-shanghai.app.tcloudbase.com/api/upload/vod/callback
事件类型: 
  - 视频上传完成
  - 视频转码完成
  - 视频审核完成
```

> **注意**：回调 URL 需要在云函数 `upload` 中实现 `/upload/vod/callback` 接口

### 3. 配置回调密钥（可选）

1. 设置回调密钥（用于验证回调签名）
2. 记录密钥，在云函数中验证回调

## 六、配置播放域名

### 1. 添加播放域名

1. 进入「**分发播放设置**」→「**域名管理**」
2. 点击「**添加域名**」
3. 填写域名：
   - 域名类型：播放域名
   - 加速区域：中国境内
   - 域名：`vod.yourdomain.com`（需要备案）

### 2. 配置 CNAME

1. 在域名解析中添加 CNAME 记录
2. 指向 VOD 提供的 CNAME 地址

### 3. 配置 HTTPS（推荐）

1. 上传 SSL 证书
2. 开启 HTTPS 访问

## 七、获取配置信息

### 1. 获取 SecretId 和 SecretKey

已在云函数环境变量中配置：
- SecretId: `AKIDiPuCHZkiZDet1zkJfrulRp45tXyBAvVs`
- SecretKey: `EE1bzEF3e2OXSAgy2yhCTZUCgwzpRq2z`

### 2. 获取 SubAppId

- 如果创建了子应用，使用子应用 ID
- 否则使用默认值：`0`

## 八、云函数配置

### 1. 环境变量

确保云函数 `upload` 和 `order` 已配置以下环境变量：

```env
TENCENT_SECRET_ID=AKIDiPuCHZkiZDet1zkJfrulRp45tXyBAvVs
TENCENT_SECRET_KEY=EE1bzEF3e2OXSAgy2yhCTZUCgwzpRq2z
TENCENT_REGION=ap-shanghai
VOD_SUB_APP_ID=0  # 如果创建了子应用，使用子应用ID
```

### 2. 实现回调接口

在 `upload` 云函数中实现 VOD 回调接口：

```javascript
// 处理 VOD 回调
if (path.endsWith('/upload/vod/callback') && method === 'POST') {
  return await handleVodCallback(event, body);
}
```

## 九、视频处理流程

### 1. 上传视频到 COS

1. 用户上传视频文件
2. 前端获取 COS 上传签名
3. 直接上传到 COS

### 2. 提交到 VOD 处理

1. 上传完成后，调用云函数
2. 云函数调用 VOD API 提交转码任务
3. 返回任务 ID

### 3. 处理完成回调

1. VOD 处理完成后，回调云函数
2. 云函数更新数据库：
   - 更新视频状态
   - 保存播放地址
   - 保存封面地址

### 4. 定时检查任务状态

1. `taskCheck` 云函数定时检查未完成的任务
2. 如果任务超时，标记为失败

## 十、测试配置

### 1. 测试视频上传

1. 上传测试视频文件
2. 检查是否成功提交到 VOD
3. 查看转码任务状态

### 2. 测试回调

1. 等待转码完成
2. 检查回调是否正常
3. 验证数据库是否更新

## 十一、常见问题

### Q: 转码任务失败

**A:** 检查：
1. 视频格式是否支持
2. 视频文件是否损坏
3. 转码模板配置是否正确

### Q: 回调未收到

**A:** 检查：
1. 回调 URL 是否正确
2. 回调 URL 是否可访问
3. 事件通知配置是否正确

### Q: 播放地址无法访问

**A:** 检查：
1. 播放域名是否配置
2. CNAME 解析是否正确
3. HTTPS 证书是否配置

### Q: 如何获取播放地址？

**A:** 
1. 使用 VOD SDK 获取播放地址
2. 或调用 VOD API 获取播放 URL

## 十二、费用说明

### 计费项

1. **存储费用**：按存储容量计费
2. **转码费用**：按转码时长计费
3. **流量费用**：按播放流量计费
4. **截图费用**：按截图数量计费

### 优化建议

1. 使用资源包降低成本
2. 合理选择转码模板
3. 使用 CDN 加速降低流量费用
4. 定期清理不需要的视频

## 十三、下一步

完成 VOD 配置后，继续：

1. ✅ **配置定时触发器** - taskCheck 函数定时任务
2. ✅ **测试视频上传** - 验证视频处理流程
3. ✅ **配置前端播放** - 集成视频播放器

---

**更新时间**: 2025年1月
**状态**: ✅ VOD 配置指南已就绪

