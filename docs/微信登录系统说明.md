# 微信登录系统说明文档

## 概述

本项目已成功实现微信登录系统，支持在关键操作点（上传视频、提交创意、支付）进行登录检查，未登录用户将弹出微信登录弹窗。

---

## 功能特性

### 1. 微信登录方式
- **微信内浏览器**：使用微信 JS-SDK（需要后端配置）
- **普通浏览器**：跳转到微信授权页面

### 2. 登录检查触发点
- 上传视频（`UploadDualVideo`）：点击"下一步"按钮时
- 提交创意（`UploadText`）：点击"提交"按钮时
- 视频支付（`UploadVideoReview`）：点击"确认支付"按钮时
- 文案支付（`UploadTextReview`）：点击"确认付款"按钮时

### 3. 登录弹窗特性
- 居中弹窗，背景半透明遮罩
- 仅显示微信登录按钮
- 支持关闭功能
- 显示加载状态
- 登录成功后自动关闭并执行回调

---

## 技术实现

### 1. 文件结构

```
src/
├── components/
│   └── LoginModal/
│       ├── LoginModal.tsx          # 微信登录弹窗组件
│       ├── LoginModal.css          # 样式文件
│       └── index.tsx               # 导出文件
├── hooks/
│   └── useRequireLogin.ts          # 登录检查 Hook
├── store/
│   └── userStore.ts                # 用户状态管理（扩展）
├── services/
│   └── userService.ts              # 用户服务（扩展）
└── constants/
    └── api.ts                       # API 端点常量（扩展）
```

### 2. 核心组件

#### LoginModal 组件
- **路径**：`src/components/LoginModal/LoginModal.tsx`
- **功能**：显示微信登录弹窗
- **样式**：绿色微信主题，圆角设计，阴影效果

#### useRequireLogin Hook
- **路径**：`src/hooks/useRequireLogin.ts`
- **功能**：检查登录状态，未登录时弹出登录弹窗
- **用法**：
  ```typescript
  const { requireLogin } = useRequireLogin();
  
  const handleSubmit = () => {
    if (!requireLogin(() => {
      // 登录成功后的回调
      console.log('登录成功，执行提交逻辑');
    })) {
      return; // 未登录，弹出登录弹窗
    }
    // 已登录，执行提交逻辑
  };
  ```

### 3. 状态管理

#### userStore 扩展
- **路径**：`src/store/userStore.ts`
- **新增状态**：
  - `loginModalVisible`: 登录弹窗显示状态
  - `loginCallback`: 登录成功后的回调函数
- **新增方法**：
  - `setLoginModalVisible`: 设置登录弹窗显示状态
  - `setLoginCallback`: 设置登录成功回调
  - `loginWithWechat`: 微信登录
  - `handleWechatCallback`: 处理微信登录回调

### 4. API 服务

#### userService 扩展
- **路径**：`src/services/userService.ts`
- **新增方法**：
  - `getWechatAuthUrl`: 获取微信授权 URL
  - `loginWithWechat`: 微信登录（处理授权码）
  - `isWechatBrowser`: 检查是否在微信浏览器中

#### API 端点
- **路径**：`src/constants/api.ts`
- **新增端点**：
  - `AUTH_WECHAT_URL`: `/auth/wechat/url` - 获取微信授权 URL
  - `AUTH_LOGIN_WECHAT`: `/auth/login/wechat` - 微信登录

---

## 微信登录流程

### 场景1：微信内浏览器

```
用户点击"微信登录"
  ↓
调用微信 JS-SDK 获取用户信息
  ↓
调用后端 API: POST /auth/login/wechat
  ↓
后端返回 token 和用户信息
  ↓
保存 token，更新用户状态
  ↓
关闭弹窗，执行回调
```

### 场景2：普通浏览器

```
用户点击"微信登录"
  ↓
获取微信授权 URL（带 redirect_uri）
  ↓
跳转到微信授权页面
  ↓
用户授权后，微信回调到 redirect_uri?code=xxx
  ↓
从 URL 获取 code
  ↓
调用后端 API: POST /auth/login/wechat { code }
  ↓
后端返回 token 和用户信息
  ↓
保存 token，更新用户状态
  ↓
清除 URL 参数，关闭弹窗，执行回调
```

---

## 后端 API 要求

### 1. 获取微信授权 URL

**接口**：`GET /auth/wechat/url`

**请求参数**：
```json
{
  "redirect_uri": "http://yourdomain.com/path?wechat_callback=1"
}
```

**响应**：
```json
{
  "url": "https://open.weixin.qq.com/connect/oauth2/authorize?appid=xxx&redirect_uri=xxx&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect"
}
```

### 2. 微信登录（处理授权码）

**接口**：`POST /auth/login/wechat`

**请求体**：
```json
{
  "code": "授权码"
}
```

**响应**：
```json
{
  "token": "JWT Token",
  "user": {
    "id": "用户ID",
    "nickname": "用户昵称",
    "avatar": "用户头像URL",
    "openid": "微信OpenID"
  }
}
```

---

## 使用示例

### 在页面中添加登录检查

```typescript
import { useRequireLogin } from '@/hooks/useRequireLogin';

export const YourPage: React.FC = () => {
  const { requireLogin } = useRequireLogin();

  const handleSensitiveAction = () => {
    // 检查登录状态
    if (!requireLogin(() => {
      // 登录成功后执行的逻辑
      console.log('用户已登录，执行敏感操作');
      // ... 你的业务逻辑
    })) {
      return; // 未登录，弹出登录弹窗
    }

    // 已登录，直接执行业务逻辑
    console.log('用户已登录，执行敏感操作');
    // ... 你的业务逻辑
  };

  return (
    <div>
      <button onClick={handleSensitiveAction}>
        执行敏感操作
      </button>
    </div>
  );
};
```

---

## 配置说明

### 环境变量

需要在 `.env` 文件中配置以下环境变量（如果需要）：

```env
# API 基础 URL
VITE_API_BASE_URL=http://localhost:3000/api

# 微信开放平台配置（后端配置）
# WECHAT_APP_ID=your_app_id
# WECHAT_APP_SECRET=your_app_secret
```

### 微信开放平台配置

1. 在微信开放平台注册应用
2. 配置授权回调域名
3. 获取 AppID 和 AppSecret
4. 在后端配置微信登录相关参数

---

## 安全性说明

1. **Token 存储**：Token 存储在 `localStorage` 中，建议后续改为 `httpOnly Cookie` 以提高安全性
2. **授权码使用**：微信授权码只能使用一次，后端需要验证
3. **回调 URL 验证**：后端需要验证回调 URL 的合法性
4. **HTTPS**：生产环境必须使用 HTTPS

---

## 测试说明

### 本地测试

1. 启动开发服务器：
   ```bash
   npm run dev
   ```

2. 访问需要登录的页面（如上传视频）

3. 点击"下一步"按钮，应该弹出登录弹窗

4. 点击"微信登录"按钮：
   - 如果在微信内浏览器，会调用 JS-SDK（需要后端配置）
   - 如果在普通浏览器，会跳转到微信授权页面（需要后端配置）

### Mock 测试

由于微信登录需要后端配置，可以在 `userStore.ts` 中添加 Mock 登录逻辑进行测试：

```typescript
loginWithWechat: async () => {
  // Mock 登录（仅用于测试）
  const mockUser = {
    id: 'mock-user-id',
    nickname: '测试用户',
    avatar: 'https://picsum.photos/100',
    openid: 'mock-openid',
  };
  
  set({ 
    user: mockUser, 
    isAuthenticated: true,
    loginModalVisible: false 
  });
  
  // 执行登录成功回调
  const { loginCallback } = get();
  if (loginCallback) {
    loginCallback();
    set({ loginCallback: null });
  }
},
```

---

## 后续优化建议

1. **自动登录**：Token 未过期时自动登录
2. **记住登录状态**：使用 `localStorage` 持久化登录状态（已实现）
3. **退出登录**：在设置页面添加退出登录功能
4. **微信 JS-SDK 集成**：在微信内浏览器中使用 JS-SDK 获取用户信息
5. **Token 刷新**：实现 Token 自动刷新机制
6. **错误处理**：完善错误处理和用户提示

---

## 常见问题

### Q1: 点击微信登录后没有反应？
A: 检查后端 API 是否正常运行，查看浏览器控制台是否有错误信息。

### Q2: 微信授权回调后没有登录成功？
A: 检查 URL 参数中是否有 `code` 和 `wechat_callback=1`，查看 `App.tsx` 中的回调处理逻辑。

### Q3: 如何在本地测试微信登录？
A: 可以使用 Mock 数据进行测试，或者配置微信开放平台的测试号。

### Q4: 登录状态如何持久化？
A: 使用 Zustand 的 `persist` 中间件，登录状态会自动保存到 `localStorage`。

---

## 更新日志

### 2024-11-23
- ✅ 实现微信登录弹窗组件
- ✅ 实现登录检查 Hook
- ✅ 在关键操作点添加登录检查
- ✅ 集成到全局 App 组件
- ✅ 处理微信登录回调

---

## 联系方式

如有问题或建议，请联系开发团队。

